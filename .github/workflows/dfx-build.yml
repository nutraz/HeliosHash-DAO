name: dfx build

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Build Docker image with dfx and mops
      run: |
        docker build -t dfx-builder -f Dockerfile.dfx .

    - name: Start replica and build canisters
      run: |
        # Start replica and build
        docker run -d --name replica dfx-builder dfx start --background --clean
        sleep 5
        docker exec replica sh -c "dfx canister create --all"
        docker exec replica sh -c "dfx build"
        
        # Run smoke test and capture logs
        docker exec replica sh -c "cd apps/backend && ./test_smoke.sh > /tmp/smoke.log 2>&1 || echo 'Smoke test exited' >> /tmp/smoke.log"
        docker cp replica:/tmp/smoke.log ./smoke.log || echo "No smoke log" > ./smoke.log
        
        # Cleanup
        docker stop replica
        docker rm replica

    - name: Upload smoke test logs
      uses: actions/upload-artifact@v4
      with:
        name: smoke-test-logs
        path: smoke.log
        retention-days: 1
