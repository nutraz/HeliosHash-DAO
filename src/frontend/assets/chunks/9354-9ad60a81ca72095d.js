(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[9354],{9354:function(t,e,n){"use strict";n.d(e,{H:function(){return AuthProvider},a:function(){return useAuth}});var r=n(7573),a=n(7653),i=n(2859),o=n(8445),l=n(1953);let hhdaoIdlFactory=t=>{let{IDL:e}=t,n=e.Variant({Planning:e.Null,Construction:e.Null,Operational:e.Null,Maintenance:e.Null}),r=e.Variant({Governance:e.Null,Project:e.Null,Treasury:e.Null}),a=e.Variant({Bronze:e.Null,Silver:e.Null,Gold:e.Null,Platinum:e.Null}),i=e.Variant({ok:e.Record({tokenId:e.Nat,owner:e.Principal,tier:a,mintedAt:e.Int,expiresAt:e.Int}),err:e.Text}),o=e.Record({tokenId:e.Nat,owner:e.Principal,tier:a,mintedAt:e.Int,expiresAt:e.Int,metadata:e.Vec(e.Tuple(e.Text,e.Text))}),l=e.Variant({ProjectFunding:e.Null,EquipmentGrant:e.Null,TrainingProgram:e.Null,CommunityEvent:e.Null}),c=e.Record({location:e.Text,capacity:e.Opt(e.Nat),budget:e.Opt(e.Nat),timeline:e.Opt(e.Text),additionalInfo:e.Opt(e.Text)}),u=e.Variant({Low:e.Null,Medium:e.Null,High:e.Null,Urgent:e.Null}),s=e.Variant({Draft:e.Null,Submitted:e.Null,UnderReview:e.Null,Approved:e.Null,Rejected:e.Null,Completed:e.Null}),p=e.Variant({Legal:e.Null,Technical:e.Null,Financial:e.Null,Environmental:e.Null,Certificate:e.Null,Report:e.Null,Image:e.Null,Video:e.Null,Other:e.Text}),d=e.Record({name:e.Text,documentType:p,mimeType:e.Text,size:e.Nat,hash:e.Text,url:e.Opt(e.Text)}),f=e.Record({id:e.Nat,applicationType:l,title:e.Text,description:e.Text,applicant:e.Principal,applicationData:c,priority:u,status:s,submittedAt:e.Int,updatedAt:e.Int,reviewer:e.Opt(e.Principal),comments:e.Opt(e.Text),documentsRequested:e.Opt(e.Vec(p)),documents:e.Vec(d),relatedProjectId:e.Opt(e.Nat)}),y=e.Record({id:e.Nat,name:e.Text,location:e.Text,capacity:e.Nat,status:n,owner:e.Principal,createdAt:e.Int,governmentApprovals:e.Vec(e.Text),telemetryId:e.Opt(e.Text),description:e.Text,estimatedCost:e.Nat,completionDate:e.Opt(e.Int)}),h=e.Variant({ok:y,err:e.Text}),m=e.Variant({ok:e.Nat,err:e.Text}),T=e.Variant({ok:e.Text,err:e.Text});return e.Service({whoami:e.Func([],[e.Principal],[]),createProject:e.Func([e.Text,e.Text,e.Nat,e.Text,e.Nat,e.Opt(e.Int)],[h],[]),getProjects:e.Func([],[e.Vec(y)],["query"]),getProject:e.Func([e.Nat],[e.Opt(y)],["query"]),updateProjectStatus:e.Func([e.Nat,n],[e.Bool],[]),createProposal:e.Func([e.Record({title:e.Text,description:e.Text,votesRequired:e.Nat,category:r})],[m],[]),vote:e.Func([e.Nat,e.Bool],[T],[]),getProposal:e.Func([e.Nat],[e.Opt(e.Record({id:e.Nat,title:e.Text,description:e.Text,proposer:e.Principal,proposalType:e.Variant({Project:e.Null,Governance:e.Null,Treasury:e.Null,Community:e.Null}),votesFor:e.Nat,votesAgainst:e.Nat,status:e.Variant({Active:e.Null,Passed:e.Null,Rejected:e.Null,Executed:e.Null}),createdAt:e.Int,votingDeadline:e.Int,executionData:e.Opt(e.Text)}))],[]),mintMembershipNFT:e.Func([e.Record({recipient:e.Principal,tier:a,durationDays:e.Nat})],[i],[]),getNFTInfo:e.Func([e.Nat],[e.Opt(o)],["query"]),submitApplication:e.Func([l,e.Text,e.Text,c,u,e.Opt(e.Nat)],[e.Nat],[]),updateApplicationStatus:e.Func([e.Nat,s,e.Opt(e.Text),e.Opt(e.Vec(p))],[e.Bool],[]),addDocumentToApplication:e.Func([e.Nat,d],[e.Bool],[]),getApplication:e.Func([e.Nat],[e.Opt(f)],["query"]),getUserApplications:e.Func([],[e.Vec(f)],["query"]),getApplicationsByStatus:e.Func([s],[e.Vec(f)],["query"]),getApplicationsByType:e.Func([l],[e.Vec(f)],["query"]),getApplicationsByReviewer:e.Func([],[e.Vec(f)],["query"]),getAllApplications:e.Func([],[e.Vec(f)],["query"]),getSystemStats:e.Func([],[e.Record({totalProjects:e.Nat,totalUsers:e.Nat,timestamp:e.Int})],["query"]),getCyclesBalance:e.Func([],[e.Nat],["query"]),seed_data:e.Func([],[e.Text],[])})},idlFactory=t=>{let{IDL:e}=t;return e.Service({mint_id_nft:e.Func([e.Text,e.Text],[e.Text],[]),register_principal:e.Func([e.Text],[e.Bool],[]),get_profile:e.Func([e.Text],[e.Opt(e.Text)],["query"])})};async function getIdentityActor(t){let e="ulvla-h7777-77774-qaacq-cai";if(!e)return null;try{let n=await (0,l.X)(e,idlFactory,t);return n}catch(t){return console.warn("Failed to create identity actor",t),null}}async function ensureKycAndMint(t,e,n){try{let r=await fetch("/api/kyc",{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify({principal:e,profile:n})});if(!r.ok)return console.warn("KYC endpoint returned non-ok status",r.status),{kyc:"unknown"};let a=await r.json(),i=(null==a?void 0:a.status)||(null==a?void 0:a.kycStatus)||"unknown";if("approved"===i){let r=await getIdentityActor(t);if(!r)return{kyc:"approved",minted:!1};try{if("function"==typeof r.mint_id_nft){let t=await r.mint_id_nft(e,JSON.stringify(n));return{kyc:"approved",minted:!!t}}if("function"==typeof r.register_principal){let t=await r.register_principal(e);return{kyc:"approved",minted:!!t}}}catch(t){return console.warn("Identity canister call failed",t),{kyc:"approved",minted:!1}}}return{kyc:i}}catch(t){return console.error("KYC + mint flow failed",t),{kyc:"error"}}}var c=n(8571);let u=(0,a.createContext)(void 0);function AuthProvider(t){let{children:e}=t,n=(0,i.useRouter)(),[s,p]=(0,a.useState)(null),[d,f]=(0,a.useState)(!0),[y,h]=(0,a.useState)(null),[m,T]=(0,a.useState)(!1),[N,g]=(0,a.useState)(0),v="helioshash_user",w=(0,a.useCallback)(t=>{try{if(!t){localStorage.removeItem(v);return}let e={principal:t.principal,name:t.name,email:t.email,avatar:t.avatar,roles:t.roles||[]};localStorage.setItem(v,JSON.stringify(e))}catch(t){}},[]),x=(0,a.useCallback)(()=>{try{let t=localStorage.getItem(v);if(!t)return null;return JSON.parse(t)}catch(t){return null}},[]),A=(0,a.useCallback)(async()=>{if(y)try{await y.logout()}catch(t){}p(null),I.current=!1},[y]),k=(0,a.useRef)(null);(0,a.useEffect)(()=>{k.current=async t=>{console.log("handleAuthentication called");try{if("function"!=typeof t.getPrincipal)throw Error("Invalid identity object");let e=t.getPrincipal();if(e&&"function"==typeof e.isAnonymous&&e.isAnonymous())throw Error("Anonymous identity not allowed");{let e="uzt4z-lp777-77774-qaabq-cai";if(e)try{await (0,l.X)(e,hhdaoIdlFactory,t)}catch(t){console.warn("Actor creation failed, continuing without backend connection:",t)}else console.warn("HHDAO canister ID not configured; skipping backend actor creation for local dev")}let r="function"==typeof(null==e?void 0:e.toText)?e.toText():String(e),a={principal:r,name:"User ".concat(r.slice(0,8),"..."),email:void 0,avatar:void 0,kycStatus:"unknown",idNftMinted:!1};p(a),(async()=>{try{let e=await ensureKycAndMint(t,r,{name:a.name});(null==e?void 0:e.kyc)&&p(t=>t?{...t,kycStatus:e.kyc}:t),(null==e?void 0:e.minted)&&p(t=>t?{...t,idNftMinted:!0}:t)}catch(t){console.warn("Background KYC/mint failed",t)}})();try{n.push("/helioshash-dao")}catch(t){}}catch(t){console.error("Authentication failed:",t),await A()}}},[A,n]),(0,a.useEffect)(()=>{console.log("AuthContext state",{user:s,authClient:!!y,isLoading:d,isClient:m})},[s,y,d,m]);let I=(0,a.useRef)(!1);(0,a.useEffect)(()=>{T(!0),async function(){try{let t=await o.AuthClient.create();h(t)}catch(t){console.error("Failed to initialize auth client:",t)}finally{f(!1)}}();try{let t=x();t&&t.principal&&p(e=>({...e||{},principal:t.principal,name:t.name,email:t.email,avatar:t.avatar,roles:t.roles||[]}))}catch(t){}},[]),(0,a.useEffect)(()=>{y&&!I.current&&!(N>=3)&&(s||async function(){I.current=!0;try{if(console.log("Auth check triggered"),await y.isAuthenticated()){var t;console.log("User is authenticated, proceeding with authentication..."),await (null===(t=k.current)||void 0===t?void 0:t.call(k,y.getIdentity()))}else console.log("User is not authenticated")}catch(t){console.error("Failed to check authentication:",t),g(t=>t+1),I.current=!1}}())},[y,N]);let F=(0,a.useCallback)(async()=>{if(!y)throw Error("Auth client not initialized");try{let t="https://identity.ic0.app";{let e="http://127.0.0.1:4943/?canisterId=".concat(c.env.NEXT_PUBLIC_INTERNET_IDENTITY_CANISTER_ID);try{let n=new AbortController,r=setTimeout(()=>n.abort(),1e3);await fetch("".concat("http://127.0.0.1:4943","/api/v2/status"),{signal:n.signal}).finally(()=>clearTimeout(r)),t=e}catch(t){console.warn("Local identity provider unreachable, falling back to https://identity.ic0.app")}}await y.login({identityProvider:t,onSuccess:async()=>{var t;await (null===(t=k.current)||void 0===t?void 0:t.call(k,y.getIdentity()))},onError:t=>{console.error("Login failed:",t)}})}catch(t){throw console.error("Login error:",t),t}},[y]),C=(0,a.useCallback)(async t=>{p(e=>{let n=e?{...e,roles:t}:null;try{w(n)}catch(t){}return n})},[w]);(0,a.useEffect)(()=>{if(m)try{w(s)}catch(t){}},[s,m,w]);let S=a.useMemo(()=>({user:m?s:null,isAuthenticated:!!m&&!!s,updateRoles:C,login:F,logout:A,isLoading:!m||d,isConnected:!!m&&!!s,walletType:m&&s?"internet-identity":null,principal:m&&(null==s?void 0:s.principal)||null,connect:F,disconnect:A}),[s,m,d,F,A,C]);return(0,r.jsx)(u.Provider,{value:S,children:e})}function useAuth(){let t=(0,a.useContext)(u);return void 0===t?{user:null,isAuthenticated:!1,login:async()=>{},logout:async()=>{},updateRoles:async()=>{},isLoading:!0,isConnected:!1,walletType:null,principal:null,connect:async()=>{},disconnect:async()=>{}}:t}},1953:function(t,e,n){"use strict";n.d(e,{X:function(){return createActor}});var r=n(991),a=n(6077);let i=new Map,o=new WeakMap;async function createActor(t,e,n){if(!t)throw Error("Canister ID not defined for actor creation");if(!/^[a-z0-9\-]+$/.test(t))throw Error("Invalid canister ID: ".concat(t));if(n&&"object"==typeof n){let e=o.get(n);if(e&&e.has(t))return e.get(t)}else if(i.has(t))return i.get(t);let l=new r.i7({identity:n,host:"http://127.0.0.1:4943"});try{await l.fetchRootKey()}catch(t){console.warn("fetchRootKey failed",t)}let c=a.vt.createActor(e,{agent:l,canisterId:t});if(n&&"object"==typeof n){let e=o.get(n);e||(e=new Map,o.set(n,e)),e.set(t,c)}else i.set(t,c);return c}},2859:function(t,e,n){t.exports=n(7699)},8571:function(t){var e,n,r,a=t.exports={};function defaultSetTimout(){throw Error("setTimeout has not been defined")}function defaultClearTimeout(){throw Error("clearTimeout has not been defined")}function runTimeout(t){if(e===setTimeout)return setTimeout(t,0);if((e===defaultSetTimout||!e)&&setTimeout)return e=setTimeout,setTimeout(t,0);try{return e(t,0)}catch(n){try{return e.call(null,t,0)}catch(n){return e.call(this,t,0)}}}function runClearTimeout(t){if(n===clearTimeout)return clearTimeout(t);if((n===defaultClearTimeout||!n)&&clearTimeout)return n=clearTimeout,clearTimeout(t);try{return n(t)}catch(e){try{return n.call(null,t)}catch(e){return n.call(this,t)}}}!function(){try{e="function"==typeof setTimeout?setTimeout:defaultSetTimout}catch(t){e=defaultSetTimout}try{n="function"==typeof clearTimeout?clearTimeout:defaultClearTimeout}catch(t){n=defaultClearTimeout}}();var i=[],o=!1,l=-1;function cleanUpNextTick(){o&&r&&(o=!1,r.length?i=r.concat(i):l=-1,i.length&&drainQueue())}function drainQueue(){if(!o){var t=runTimeout(cleanUpNextTick);o=!0;for(var e=i.length;e;){for(r=i,i=[];++l<e;)r&&r[l].run();l=-1,e=i.length}r=null,o=!1,runClearTimeout(t)}}function Item(t,e){this.fun=t,this.array=e}function noop(){}a.nextTick=function(t){var e=Array(arguments.length-1);if(arguments.length>1)for(var n=1;n<arguments.length;n++)e[n-1]=arguments[n];i.push(new Item(t,e)),1!==i.length||o||runTimeout(drainQueue)},Item.prototype.run=function(){this.fun.apply(null,this.array)},a.title="browser",a.browser=!0,a.env={},a.argv=[],a.version="",a.versions={},a.on=noop,a.addListener=noop,a.once=noop,a.off=noop,a.removeListener=noop,a.removeAllListeners=noop,a.emit=noop,a.prependListener=noop,a.prependOnceListener=noop,a.listeners=function(t){return[]},a.binding=function(t){throw Error("process.binding is not supported")},a.cwd=function(){return"/"},a.chdir=function(t){throw Error("process.chdir is not supported")},a.umask=function(){return 0}}}]);