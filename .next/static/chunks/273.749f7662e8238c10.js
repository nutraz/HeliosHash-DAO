"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[273],{3273:function(e,t,r){let i,n;r.d(t,{AuthClient:function(){return AuthClient}});var a=r(7638),o=r(5572),s=r(8831);let CryptoError=class CryptoError extends Error{constructor(e){super(e),this.message=e,Object.setPrototypeOf(this,CryptoError.prototype)}};function _getEffectiveCrypto(e){if("undefined"!=typeof global&&global.crypto&&global.crypto.subtle)return global.crypto.subtle;if(e)return e;if("undefined"!=typeof crypto&&crypto.subtle)return crypto.subtle;throw new CryptoError("Global crypto was not available and none was provided. Please inlcude a SubtleCrypto implementation. See https://developer.mozilla.org/en-US/docs/Web/API/SubtleCrypto")}let ECDSAKeyIdentity=class ECDSAKeyIdentity extends a.$4{static async generate(e){let{extractable:t=!1,keyUsages:r=["sign","verify"],subtleCrypto:i}=e??{},n=_getEffectiveCrypto(i),a=await n.generateKey({name:"ECDSA",namedCurve:"P-256"},t,r),o=(0,s.ZP)(await n.exportKey("spki",a.publicKey));return Object.assign(o,{__derEncodedPublicKey__:void 0}),new this(a,o,n)}static async fromKeyPair(e,t){let r=_getEffectiveCrypto(t),i=(0,s.ZP)(await r.exportKey("spki",e.publicKey));return Object.assign(i,{__derEncodedPublicKey__:void 0}),new ECDSAKeyIdentity(e,i,r)}constructor(e,t,r){super(),this._keyPair=e,this._derKey=t,this._subtleCrypto=r}getKeyPair(){return this._keyPair}getPublicKey(){let e=this._derKey,t=Object.create(this._keyPair.publicKey);return t.toDer=function(){return e},t}async sign(e){let t=(0,s.ZP)(await this._subtleCrypto.sign({name:"ECDSA",hash:{name:"SHA-256"}},this._keyPair.privateKey,e));return Object.assign(t,{__signature__:void 0}),t}};var l=r(1050),c=r(1735),u=r(6702);let PartialIdentity=class PartialIdentity{#e;get rawKey(){return this.#e.rawKey}get derKey(){return this.#e.derKey}toDer(){return this.#e.toDer()}getPublicKey(){return this.#e}getPrincipal(){if(!this.#e.rawKey)throw Error("Cannot get principal from a public key without a raw key.");return u.R.fromUint8Array(new Uint8Array(this.#e.rawKey))}transformRequest(){return Promise.reject("Not implemented. You are attempting to use a partial identity to sign calls, but this identity only has access to the public key.To sign calls, use a DelegationIdentity instead.")}constructor(e){this.#e=e}};var d=r(2305);function safeBytesToHex(e){return e instanceof Uint8Array?(0,d.ci)(e):(0,d.ci)(new Uint8Array(e))}function _parseBlob(e){if("string"!=typeof e||e.length<64)throw Error("Invalid public key.");return(0,d.nr)(e)}let Delegation=class Delegation{constructor(e,t,r){this.pubkey=e,this.expiration=t,this.targets=r}toCborValue(){return{pubkey:this.pubkey,expiration:this.expiration,...this.targets&&{targets:this.targets}}}toJSON(){return{expiration:this.expiration.toString(16),pubkey:safeBytesToHex(this.pubkey),...this.targets&&{targets:this.targets.map(e=>e.toHex())}}}};async function _createSingleDelegation(e,t,r,i){let n=new Delegation(t.toDer(),BigInt(+r)*BigInt(1e6),i),a=new Uint8Array([...l.d8,...new Uint8Array((0,c.vH)({...n}))]),o=await e.sign(a);return{delegation:n,signature:o}}let DelegationChain=class DelegationChain{static async create(e,t,r=new Date(Date.now()+9e5),i={}){let n=await _createSingleDelegation(e,t,r,i.targets);return new DelegationChain([...i.previous?.delegations||[],n],i.previous?.publicKey||e.getPublicKey().toDer())}static fromJSON(e){let{publicKey:t,delegations:r}="string"==typeof e?JSON.parse(e):e;if(!Array.isArray(r))throw Error("Invalid delegations.");let i=r.map(e=>{let{delegation:t,signature:r}=e,{pubkey:i,expiration:n,targets:a}=t;if(void 0!==a&&!Array.isArray(a))throw Error("Invalid targets.");return{delegation:new Delegation(_parseBlob(i),BigInt("0x"+n),a&&a.map(e=>{if("string"!=typeof e)throw Error("Invalid target.");return u.R.fromHex(e)})),signature:_parseBlob(r)}});return new this(i,_parseBlob(t))}static fromDelegations(e,t){return new this(e,t)}constructor(e,t){this.delegations=e,this.publicKey=t}toJSON(){return{delegations:this.delegations.map(e=>{let{delegation:t,signature:r}=e,{targets:i}=t;return{delegation:{expiration:t.expiration.toString(16),pubkey:safeBytesToHex(t.pubkey),...i&&{targets:i.map(e=>e.toHex())}},signature:safeBytesToHex(r)}}),publicKey:safeBytesToHex(this.publicKey)}}};let DelegationIdentity=class DelegationIdentity extends a.$4{static fromDelegation(e,t){return new this(e,t)}constructor(e,t){super(),this._inner=e,this._delegation=t}getDelegation(){return this._delegation}getPublicKey(){return{derKey:this._delegation.publicKey,toDer:()=>this._delegation.publicKey}}sign(e){return this._inner.sign(e)}async transformRequest(e){let{body:t,...r}=e,i=await (0,c.vH)(t);return{...r,body:{content:t,sender_sig:await this.sign(new Uint8Array([...l.Wf,...new Uint8Array(i)])),sender_delegation:this._delegation.delegations,sender_pubkey:this._delegation.publicKey}}}};let PartialDelegationIdentity=class PartialDelegationIdentity extends PartialIdentity{#t;get delegation(){return this.#t}constructor(e,t){super(e),this.#t=t}static fromDelegation(e,t){return new PartialDelegationIdentity(e,t)}};function isDelegationValid(e,t){for(let{delegation:t}of e.delegations)if(+new Date(Number(t.expiration/BigInt(1e6)))<=+Date.now())return!1;let r=[],i=t?.scope;for(let t of(i&&(Array.isArray(i)?r.push(...i.map(e=>"string"==typeof e?u.R.fromText(e):e)):r.push("string"==typeof i?u.R.fromText(i):i)),r)){let r=t.toText();for(let{delegation:t}of e.delegations){if(void 0===t.targets)continue;let e=!0;for(let i of t.targets)if(i.toText()===r){e=!1;break}if(e)return!1}}return!0}let y=["mousedown","mousemove","keydown","touchstart","wheel"];let IdleManager=class IdleManager{callbacks=[];idleTimeout=6e5;timeoutID=void 0;static create(e={}){return new this(e)}constructor(e={}){let{onIdle:t,idleTimeout:r=6e5}=e||{};this.callbacks=t?[t]:[],this.idleTimeout=r;let i=this._resetTimer.bind(this);if(window.addEventListener("load",i,!0),y.forEach(function(e){document.addEventListener(e,i,!0)}),e?.captureScroll){let t=((e,t)=>{let r;return(...i)=>{let n=this;clearTimeout(r),r=window.setTimeout(function(){r=void 0,e.apply(n,i)},t)}})(i,e?.scrollDebounce??100);window.addEventListener("scroll",t,!0)}i()}registerCallback(e){this.callbacks.push(e)}exit(){clearTimeout(this.timeoutID),window.removeEventListener("load",this._resetTimer,!0);let e=this._resetTimer.bind(this);y.forEach(function(t){document.removeEventListener(t,e,!0)}),this.callbacks.forEach(e=>e())}_resetTimer(){let e=this.exit.bind(this);window.clearTimeout(this.timeoutID),this.timeoutID=window.setTimeout(e,this.idleTimeout)}};let instanceOfAny=(e,t)=>t.some(t=>e instanceof t);function getIdbProxyableTypes(){return i||(i=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function getCursorAdvanceMethods(){return n||(n=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}let h=new WeakMap,g=new WeakMap,p=new WeakMap,f=new WeakMap,w=new WeakMap;function promisifyRequest(e){let t=new Promise((t,r)=>{let unlisten=()=>{e.removeEventListener("success",success),e.removeEventListener("error",error)},success=()=>{t(wrap_idb_value_wrap(e.result)),unlisten()},error=()=>{r(e.error),unlisten()};e.addEventListener("success",success),e.addEventListener("error",error)});return t.then(t=>{t instanceof IDBCursor&&h.set(t,e)}).catch(()=>{}),w.set(t,e),t}function cacheDonePromiseForTransaction(e){if(g.has(e))return;let t=new Promise((t,r)=>{let unlisten=()=>{e.removeEventListener("complete",complete),e.removeEventListener("error",error),e.removeEventListener("abort",error)},complete=()=>{t(),unlisten()},error=()=>{r(e.error||new DOMException("AbortError","AbortError")),unlisten()};e.addEventListener("complete",complete),e.addEventListener("error",error),e.addEventListener("abort",error)});g.set(e,t)}let _={get(e,t,r){if(e instanceof IDBTransaction){if("done"===t)return g.get(e);if("objectStoreNames"===t)return e.objectStoreNames||p.get(e);if("store"===t)return r.objectStoreNames[1]?void 0:r.objectStore(r.objectStoreNames[0])}return wrap_idb_value_wrap(e[t])},set:(e,t,r)=>(e[t]=r,!0),has:(e,t)=>e instanceof IDBTransaction&&("done"===t||"store"===t)||t in e};function replaceTraps(e){_=e(_)}function wrapFunction(e){return e!==IDBDatabase.prototype.transaction||"objectStoreNames"in IDBTransaction.prototype?getCursorAdvanceMethods().includes(e)?function(...t){return e.apply(unwrap(this),t),wrap_idb_value_wrap(h.get(this))}:function(...t){return wrap_idb_value_wrap(e.apply(unwrap(this),t))}:function(t,...r){let i=e.call(unwrap(this),t,...r);return p.set(i,t.sort?t.sort():[t]),wrap_idb_value_wrap(i)}}function transformCachableValue(e){return"function"==typeof e?wrapFunction(e):(e instanceof IDBTransaction&&cacheDonePromiseForTransaction(e),instanceOfAny(e,getIdbProxyableTypes()))?new Proxy(e,_):e}function wrap_idb_value_wrap(e){if(e instanceof IDBRequest)return promisifyRequest(e);if(f.has(e))return f.get(e);let t=transformCachableValue(e);return t!==e&&(f.set(e,t),w.set(t,e)),t}let unwrap=e=>w.get(e);function openDB(e,t,{blocked:r,upgrade:i,blocking:n,terminated:a}={}){let o=indexedDB.open(e,t),s=wrap_idb_value_wrap(o);return i&&o.addEventListener("upgradeneeded",e=>{i(wrap_idb_value_wrap(o.result),e.oldVersion,e.newVersion,wrap_idb_value_wrap(o.transaction),e)}),r&&o.addEventListener("blocked",e=>r(e.oldVersion,e.newVersion,e)),s.then(e=>{a&&e.addEventListener("close",()=>a()),n&&e.addEventListener("versionchange",e=>n(e.oldVersion,e.newVersion,e))}).catch(()=>{}),s}let m=["get","getKey","getAll","getAllKeys","count"],b=["put","add","delete","clear"],v=new Map;function getMethod(e,t){if(!(e instanceof IDBDatabase&&!(t in e)&&"string"==typeof t))return;if(v.get(t))return v.get(t);let r=t.replace(/FromIndex$/,""),i=t!==r,n=b.includes(r);if(!(r in(i?IDBIndex:IDBObjectStore).prototype)||!(n||m.includes(r)))return;let method=async function(e,...t){let a=this.transaction(e,n?"readwrite":"readonly"),o=a.store;return i&&(o=o.index(t.shift())),(await Promise.all([o[r](...t),n&&a.done]))[0]};return v.set(t,method),method}replaceTraps(e=>({...e,get:(t,r,i)=>getMethod(t,r)||e.get(t,r,i),has:(t,r)=>!!getMethod(t,r)||e.has(t,r)}));let D="auth-client-db",K="ic-keyval",_openDbStore=async(e=D,t=K,r)=>(P&&localStorage?.getItem(I)&&(localStorage.removeItem(I),localStorage.removeItem(E)),await openDB(e,r,{upgrade:e=>{e.objectStoreNames.contains(t)&&e.clear(t),e.createObjectStore(t)}}));async function _getValue(e,t,r){return await e.get(t,r)}async function _setValue(e,t,r,i){return await e.put(t,i,r)}async function _removeValue(e,t,r){return await e.delete(t,r)}let IdbKeyVal=class IdbKeyVal{_db;_storeName;static async create(e){let{dbName:t=D,storeName:r=K,version:i=S}=e??{},n=await _openDbStore(t,r,i);return new IdbKeyVal(n,r)}constructor(e,t){this._db=e,this._storeName=t}async set(e,t){return await _setValue(this._db,this._storeName,e,t)}async get(e){return await _getValue(this._db,this._storeName,e)??null}async remove(e){return await _removeValue(this._db,this._storeName,e)}};let E="identity",I="delegation",S=1,P="undefined"!=typeof window;let LocalStorage=class LocalStorage{prefix;_localStorage;constructor(e="ic-",t){this.prefix=e,this._localStorage=t}get(e){return Promise.resolve(this._getLocalStorage().getItem(this.prefix+e))}set(e,t){return this._getLocalStorage().setItem(this.prefix+e,t),Promise.resolve()}remove(e){return this._getLocalStorage().removeItem(this.prefix+e),Promise.resolve()}_getLocalStorage(){if(this._localStorage)return this._localStorage;let e="undefined"==typeof window?"undefined"==typeof global?"undefined"==typeof self?void 0:self.localStorage:global.localStorage:window.localStorage;if(!e)throw Error("Could not find local storage.");return e}};let IdbStorage=class IdbStorage{#r;constructor(e){this.#r=e??{}}initializedDb;get _db(){return new Promise((e,t)=>{if(this.initializedDb){e(this.initializedDb);return}IdbKeyVal.create(this.#r).then(t=>{this.initializedDb=t,e(t)}).catch(t)})}async get(e){let t=await this._db;return await t.get(e)}async set(e,t){let r=await this._db;await r.set(e,t)}async remove(e){let t=await this._db;await t.remove(e)}};let k=BigInt(1e9),A=BigInt(3600),x=BigInt(8)*(k*A),O="ECDSA",C="Ed25519";let AuthClient=class AuthClient{_identity;_key;_chain;_storage;idleManager;_createOptions;_idpWindow;_eventHandler;static async create(e={}){let t;let r=e.storage??new IdbStorage,i=e.keyType??O,n=null;if(e.identity)n=e.identity;else{let e=await r.get(E);if(!e&&P)try{let t=new LocalStorage,n=await t.get(I),a=await t.get(E);n&&a&&i===O&&(console.log("Discovered an identity stored in localstorage. Migrating to IndexedDB"),await r.set(I,n),await r.set(E,a),e=n,await t.remove(I),await t.remove(E))}catch(e){console.error("error while attempting to recover localstorage: "+e)}if(e)try{"object"==typeof e?n=i===C&&"string"==typeof e?o.R.fromJSON(e):await ECDSAKeyIdentity.fromKeyPair(e):"string"==typeof e&&(n=o.R.fromJSON(e))}catch{}}let s=new a.ed,l=null;if(n)try{let t=await r.get(I);if("object"==typeof t&&null!==t)throw Error("Delegation chain is incorrectly stored. A delegation chain should be stored as a string.");e.identity?s=e.identity:t&&(l=DelegationChain.fromJSON(t),isDelegationValid(l)?s="toDer"in n?PartialDelegationIdentity.fromDelegation(n,l):DelegationIdentity.fromDelegation(n,l):(await _deleteStorage(r),n=null))}catch(e){console.error(e),await _deleteStorage(r),n=null}return e.idleOptions?.disableIdle?t=void 0:(l||e.identity)&&(t=IdleManager.create(e.idleOptions)),n||(i===C?(n=o.R.generate(),await r.set(E,JSON.stringify(n.toJSON()))):(e.storage&&i===O&&console.warn(`You are using a custom storage provider that may not support CryptoKey storage. If you are using a custom storage provider that does not support CryptoKey storage, you should use '${C}' as the key type, as it can serialize to a string`),n=await ECDSAKeyIdentity.generate(),await r.set(E,n.getKeyPair()))),new this(s,n,l,r,t,e)}constructor(e,t,r,i,n,a,o,s){this._identity=e,this._key=t,this._chain=r,this._storage=i,this.idleManager=n,this._createOptions=a,this._idpWindow=o,this._eventHandler=s,this._registerDefaultIdleCallback()}_registerDefaultIdleCallback(){let e=this._createOptions?.idleOptions;e?.onIdle||e?.disableDefaultIdleCallback||this.idleManager?.registerCallback(()=>{this.logout(),location.reload()})}async _handleSuccess(e,t){let r=e.delegations.map(e=>({delegation:new Delegation(e.delegation.pubkey,e.delegation.expiration,e.delegation.targets),signature:e.signature})),i=DelegationChain.fromDelegations(r,e.userPublicKey),n=this._key;if(!n)return;this._chain=i,"toDer"in n?this._identity=PartialDelegationIdentity.fromDelegation(n,this._chain):this._identity=DelegationIdentity.fromDelegation(n,this._chain),this._idpWindow?.close();let a=this._createOptions?.idleOptions;this.idleManager||a?.disableIdle||(this.idleManager=IdleManager.create(a),this._registerDefaultIdleCallback()),this._removeEventListener(),delete this._idpWindow,this._chain&&await this._storage.set(I,JSON.stringify(this._chain.toJSON())),t?.(e)}getIdentity(){return this._identity}async isAuthenticated(){return!this.getIdentity().getPrincipal().isAnonymous()&&null!==this._chain&&isDelegationValid(this._chain)}async login(e){let t=mergeLoginOptions(this._createOptions?.loginOptions,e),r=t?.maxTimeToLive??x,i=new URL(t?.identityProvider?.toString()||"https://identity.internetcomputer.org");i.hash="#authorize",this._idpWindow?.close(),this._removeEventListener(),this._eventHandler=this._getEventHandler(i,{maxTimeToLive:r,...t}),window.addEventListener("message",this._eventHandler),this._idpWindow=window.open(i.toString(),"idpWindow",t?.windowOpenerFeatures)??void 0;let checkInterruption=()=>{this._idpWindow&&(this._idpWindow.closed?this._handleFailure("UserInterrupt",t?.onError):setTimeout(checkInterruption,500))};checkInterruption()}_getEventHandler(e,t){return async r=>{if(r.origin!==e.origin)return;let i=r.data;switch(i.kind){case"authorize-ready":{let r={kind:"authorize-client",sessionPublicKey:new Uint8Array(this._key?.getPublicKey().toDer()),maxTimeToLive:t?.maxTimeToLive,allowPinAuthentication:t?.allowPinAuthentication,derivationOrigin:t?.derivationOrigin?.toString(),...t?.customValues};this._idpWindow?.postMessage(r,e.origin);break}case"authorize-client-success":try{await this._handleSuccess(i,t?.onSuccess)}catch(e){this._handleFailure(e.message,t?.onError)}break;case"authorize-client-failure":this._handleFailure(i.text,t?.onError)}}}_handleFailure(e,t){this._idpWindow?.close(),t?.(e),this._removeEventListener(),delete this._idpWindow}_removeEventListener(){this._eventHandler&&window.removeEventListener("message",this._eventHandler),this._eventHandler=void 0}async logout(e={}){if(await _deleteStorage(this._storage),this._identity=new a.ed,this._chain=null,e.returnTo)try{window.history.pushState({},"",e.returnTo)}catch{window.location.href=e.returnTo}}};async function _deleteStorage(e){await e.remove(E),await e.remove(I),await e.remove("iv")}function mergeLoginOptions(e,t){if(!e&&!t)return;let r=e?.customValues||t?.customValues?{...e?.customValues,...t?.customValues}:void 0;return{...e,...t,customValues:r}}},5572:function(e,t,r){r.d(t,{R:function(){return Ed25519KeyIdentity}});var i=r(3870),n=r(7638),a=r(8831),o=r(9822),s=r(2305);function isObject(e){return null!==e&&"object"==typeof e}let Ed25519PublicKey=class Ed25519PublicKey{static from(e){if("string"==typeof e){let t=(0,s.nr)(e);return this.fromRaw(t)}if(isObject(e)){if(isObject(e)&&Object.hasOwnProperty.call(e,"__derEncodedPublicKey__"))return this.fromDer(e);if(ArrayBuffer.isView(e))return this.fromRaw((0,a.ZP)(e.buffer));if(e instanceof ArrayBuffer)return this.fromRaw((0,a.ZP)(e));if("rawKey"in e&&e.rawKey instanceof Uint8Array)return this.fromRaw(e.rawKey);else if("derKey"in e)return this.fromDer(e.derKey);else if("toDer"in e)return this.fromDer(e.toDer())}throw Error("Cannot construct Ed25519PublicKey from the provided key.")}static fromRaw(e){return new Ed25519PublicKey(e)}static fromDer(e){return new Ed25519PublicKey(this.derDecode(e))}static{this.RAW_KEY_LENGTH=32}static derEncode(e){let t=(0,i.nt)(e,i.BM);return t.__derEncodedPublicKey__=void 0,t}static derDecode(e){let t=(0,i.eZ)(e,i.BM);if(t.length!==this.RAW_KEY_LENGTH)throw Error("An Ed25519 public key must be exactly 32bytes long");return t}#i;get rawKey(){return this.#i}#n;get derKey(){return this.#n}constructor(e){if(e.byteLength!==Ed25519PublicKey.RAW_KEY_LENGTH)throw Error("An Ed25519 public key must be exactly 32bytes long");this.#i=e,this.#n=Ed25519PublicKey.derEncode(e)}toDer(){return this.derKey}toRaw(){return this.rawKey}};let Ed25519KeyIdentity=class Ed25519KeyIdentity extends n.$4{static generate(e){if(e&&32!==e.length)throw Error("Ed25519 Seed needs to be 32 bytes long.");e||(e=o.UN.utils.randomPrivateKey()),(0,a.mK)(e,new Uint8Array(Array(32).fill(0)))&&console.warn("Seed is all zeros. This is not a secure seed. Please provide a seed with sufficient entropy if this is a production environment.");let t=new Uint8Array(32);for(let r=0;r<32;r++)t[r]=e[r];let r=o.UN.getPublicKey(t);return Ed25519KeyIdentity.fromKeyPair(r,t)}static fromParsedJson(e){let[t,r]=e;return new Ed25519KeyIdentity(Ed25519PublicKey.fromDer((0,s.nr)(t)),(0,s.nr)(r))}static fromJSON(e){let t=JSON.parse(e);if(Array.isArray(t)){if("string"==typeof t[0]&&"string"==typeof t[1])return this.fromParsedJson([t[0],t[1]]);throw Error("Deserialization error: JSON must have at least 2 items.")}throw Error(`Deserialization error: Invalid JSON type for string: ${JSON.stringify(e)}`)}static fromKeyPair(e,t){return new Ed25519KeyIdentity(Ed25519PublicKey.fromRaw(e),t)}static fromSecretKey(e){let t=o.UN.getPublicKey(e);return Ed25519KeyIdentity.fromKeyPair(t,e)}#a;#o;constructor(e,t){super(),this.#a=Ed25519PublicKey.from(e),this.#o=t}toJSON(){return[(0,s.ci)(this.#a.toDer()),(0,s.ci)(this.#o)]}getKeyPair(){return{secretKey:this.#o,publicKey:this.#a}}getPublicKey(){return this.#a}async sign(e){let t=o.UN.sign(e,this.#o.slice(0,32));return Object.defineProperty(t,"__signature__",{enumerable:!1,value:void 0}),t}static verify(e,t,r){let[i,n,l]=[e,t,r].map(e=>("string"==typeof e&&(e=(0,s.nr)(e)),(0,a.ZP)(e)));return o.UN.verify(i,n,l)}}}}]);