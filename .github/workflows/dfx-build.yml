name: dfx build

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  name: dfx build

  on:
    push:
      branches: [ main ]
    pull_request:
      branches: [ main ]

  jobs:
    build:
      runs-on: ubuntu-latest

      steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build Docker image with dfx and mops (multi-stage)
        run: |
          docker build -t dfx-builder -f Dockerfile.dfx.multistage .

      - name: Start replica and build canisters
        run: |
          # Start replica and build
          docker run -d --name replica dfx-builder dfx start --background --clean
          sleep 5
          docker exec replica sh -c "dfx canister create --all"
          docker exec replica sh -c "dfx build"

          # Run smoke test (best-effort; don't fail the job on smoke test errors)
          docker exec replica sh -c "cd apps/backend && ./test_smoke.sh" || echo "Smoke test finished (non-fatal)"

          # Cleanup
          docker stop replica
          name: dfx build

          on:
            push:
              branches: [ main ]
            pull_request:
              branches: [ main ]

          jobs:
            build:
              runs-on: ubuntu-latest

              steps:
              - name: Checkout repository
                uses: actions/checkout@v4

              - name: Build Docker image with dfx and mops (multi-stage)
                run: |
                  docker build -t dfx-builder -f Dockerfile.dfx.multistage .

              - name: Start replica and build canisters
                run: |
                  set -euo pipefail

                  # Start replica in a container
                  docker run -d --name replica dfx-builder dfx start --background --clean
                  sleep 5

                  # Create canisters and build
                  docker exec replica sh -c "dfx canister create --all"
                  docker exec replica sh -c "dfx build"

                  # Run smoke test and capture logs (non-fatal): write to /tmp/smoke.log inside container
                  docker exec replica sh -c "cd apps/backend && ./test_smoke.sh > /tmp/smoke.log 2>&1 || echo 'Smoke test exited with status: $?' >> /tmp/smoke.log"

                  # Copy smoke log out of container for artifact upload; if it fails, create a placeholder
                  docker cp replica:/tmp/smoke.log ./smoke.log || echo "Could not copy smoke log" > ./smoke.log

                  # Cleanup
                  docker stop replica
                  docker rm replica

              - name: Upload smoke test logs
                uses: actions/upload-artifact@v4
                with:
                  name: smoke-test-logs
                  path: smoke.log
                  retention-days: 1
