name: dfx build

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build Docker image with dfx and mops
        run: |
          set -e
          docker build -t dfx-builder -f Dockerfile.dfx .

      - name: Start replica and build canisters
        run: |
          set -e
          # Start replica in background inside a container
          docker run -d --name dfx-replica dfx-builder bash -lc "dfx start --background --clean || true"

          # Run canister create/build inside a container that mounts the repo
          docker run --rm -v "$PWD":/workspace -w /workspace dfx-builder bash -lc "cd apps/backend && dfx canister create --all && dfx build"

          # Cleanup the replica container
          docker stop dfx-replica || true
          docker rm dfx-replica || true
