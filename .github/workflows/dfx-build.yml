name: dfx build

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-canisters:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build docker image with dfx + mops
        run: |
          set -e
          # Build a container image that installs dfx and mops non-interactively
          docker build -t helios-dfx - <<'DOCKERFILE'
          FROM ubuntu:24.04
          ENV DEBIAN_FRONTEND=noninteractive
          RUN apt-get update && apt-get install -y curl ca-certificates tar gzip xz-utils gnupg \
              && rm -rf /var/lib/apt/lists/*

          # Install dfx by downloading the prebuilt tarball via the official installer script
          RUN mkdir -p /opt/dfx && \
              curl -fsSL https://sdk.dfinity.org/install.sh | bash -s -- --no-modify-path --install-dir /opt/dfx || true

          # If the installer didn't place the dfx binary, try extracting the tarball directly
          RUN if [ -d /opt/dfx ]; then true; else mkdir -p /opt/dfx; fi

          ENV PATH="/opt/dfx:$PATH"

          # Install mops (Motoko package manager)
          RUN curl -fsSL https://mops.one/install.sh | bash || true
          ENV PATH="/root/.local/bin:/root/.cache/dfx/versions/$(ls /root/.cache/dfx/versions 2>/dev/null || true):$PATH"

          WORKDIR /work
          DOCKERFILE

      - name: Run canister build inside container
        run: |
          set -e
          # Mount repo into the container and run dfx commands there
          docker run --rm -v "$PWD":/work -w /work helios-dfx bash -lc "cd apps/backend && dfx canister create --all && dfx build"

      - name: Stop any background dfx processes (best-effort)
        if: always()
        run: |
          docker run --rm -v "$PWD":/work -w /work helios-dfx bash -lc "dfx stop || true" || true
