name: dfx build

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  name: dfx build

  on:
    push:
      branches: [ main ]
    pull_request:
      branches: [ main ]

  jobs:
    build:
      runs-on: ubuntu-latest

      steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build Docker image with dfx and mops (multi-stage)
        run: |
          docker build -t dfx-builder -f Dockerfile.dfx.multistage .

      - name: Start replica and build canisters
        run: |
          # Start replica and build
          docker run -d --name replica dfx-builder dfx start --background --clean
          sleep 5
          docker exec replica sh -c "dfx canister create --all"
          docker exec replica sh -c "dfx build"

          # Run smoke test (best-effort; don't fail the job on smoke test errors)
          docker exec replica sh -c "cd apps/backend && ./test_smoke.sh" || echo "Smoke test finished (non-fatal)"

          # Cleanup
          docker stop replica
          docker rm replica
