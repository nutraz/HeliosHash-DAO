name: dfx build

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build Docker image with dfx and mops
        run: |
          set -e
          docker build -t dfx-builder -f Dockerfile.dfx .

      - name: Start replica and build canisters
        run: |
          set -e
          # Run all dfx commands inside a single container so the replica started by dfx is reachable
          docker run --rm -v "$PWD":/workspace -w /workspace dfx-builder bash -lc '
            set -e
            cd apps/backend
            echo "Starting dfx local replica in background..."
            dfx start --background --clean
            # small wait to allow the replica to become reachable
            sleep 3
            echo "Creating canisters..."
            dfx canister create --all
            echo "Building canisters..."
            dfx build
          '
