"use strict";exports.id=977,exports.ids=[977],exports.modules={7977:(e,t,i)=>{let r,n;i.d(t,{AuthClient:()=>AuthClient});var a=i(4791),o=i(4326),s=i(2484);let CryptoError=class CryptoError extends Error{constructor(e){super(e),this.message=e,Object.setPrototypeOf(this,CryptoError.prototype)}};function _getEffectiveCrypto(e){if("undefined"!=typeof global&&global.crypto&&global.crypto.subtle)return global.crypto.subtle;if(e)return e;if("undefined"!=typeof crypto&&crypto.subtle)return crypto.subtle;throw new CryptoError("Global crypto was not available and none was provided. Please inlcude a SubtleCrypto implementation. See https://developer.mozilla.org/en-US/docs/Web/API/SubtleCrypto")}let ECDSAKeyIdentity=class ECDSAKeyIdentity extends a.$4{static async generate(e){let{extractable:t=!1,keyUsages:i=["sign","verify"],subtleCrypto:r}=e??{},n=_getEffectiveCrypto(r),a=await n.generateKey({name:"ECDSA",namedCurve:"P-256"},t,i),o=(0,s.ZP)(await n.exportKey("spki",a.publicKey));return Object.assign(o,{__derEncodedPublicKey__:void 0}),new this(a,o,n)}static async fromKeyPair(e,t){let i=_getEffectiveCrypto(t),r=(0,s.ZP)(await i.exportKey("spki",e.publicKey));return Object.assign(r,{__derEncodedPublicKey__:void 0}),new ECDSAKeyIdentity(e,r,i)}constructor(e,t,i){super(),this._keyPair=e,this._derKey=t,this._subtleCrypto=i}getKeyPair(){return this._keyPair}getPublicKey(){let e=this._derKey,t=Object.create(this._keyPair.publicKey);return t.toDer=function(){return e},t}async sign(e){let t=(0,s.ZP)(await this._subtleCrypto.sign({name:"ECDSA",hash:{name:"SHA-256"}},this._keyPair.privateKey,e));return Object.assign(t,{__signature__:void 0}),t}};var l=i(253),c=i(3482),u=i(7668);let PartialIdentity=class PartialIdentity{#e;get rawKey(){return this.#e.rawKey}get derKey(){return this.#e.derKey}toDer(){return this.#e.toDer()}getPublicKey(){return this.#e}getPrincipal(){if(!this.#e.rawKey)throw Error("Cannot get principal from a public key without a raw key.");return u.R.fromUint8Array(new Uint8Array(this.#e.rawKey))}transformRequest(){return Promise.reject("Not implemented. You are attempting to use a partial identity to sign calls, but this identity only has access to the public key.To sign calls, use a DelegationIdentity instead.")}constructor(e){this.#e=e}};var d=i(1947);function safeBytesToHex(e){return e instanceof Uint8Array?(0,d.ci)(e):(0,d.ci)(new Uint8Array(e))}function _parseBlob(e){if("string"!=typeof e||e.length<64)throw Error("Invalid public key.");return(0,d.nr)(e)}let Delegation=class Delegation{constructor(e,t,i){this.pubkey=e,this.expiration=t,this.targets=i}toCborValue(){return{pubkey:this.pubkey,expiration:this.expiration,...this.targets&&{targets:this.targets}}}toJSON(){return{expiration:this.expiration.toString(16),pubkey:safeBytesToHex(this.pubkey),...this.targets&&{targets:this.targets.map(e=>e.toHex())}}}};async function _createSingleDelegation(e,t,i,r){let n=new Delegation(t.toDer(),BigInt(+i)*BigInt(1e6),r),a=new Uint8Array([...l.d8,...new Uint8Array((0,c.vH)({...n}))]),o=await e.sign(a);return{delegation:n,signature:o}}let DelegationChain=class DelegationChain{static async create(e,t,i=new Date(Date.now()+9e5),r={}){let n=await _createSingleDelegation(e,t,i,r.targets);return new DelegationChain([...r.previous?.delegations||[],n],r.previous?.publicKey||e.getPublicKey().toDer())}static fromJSON(e){let{publicKey:t,delegations:i}="string"==typeof e?JSON.parse(e):e;if(!Array.isArray(i))throw Error("Invalid delegations.");let r=i.map(e=>{let{delegation:t,signature:i}=e,{pubkey:r,expiration:n,targets:a}=t;if(void 0!==a&&!Array.isArray(a))throw Error("Invalid targets.");return{delegation:new Delegation(_parseBlob(r),BigInt("0x"+n),a&&a.map(e=>{if("string"!=typeof e)throw Error("Invalid target.");return u.R.fromHex(e)})),signature:_parseBlob(i)}});return new this(r,_parseBlob(t))}static fromDelegations(e,t){return new this(e,t)}constructor(e,t){this.delegations=e,this.publicKey=t}toJSON(){return{delegations:this.delegations.map(e=>{let{delegation:t,signature:i}=e,{targets:r}=t;return{delegation:{expiration:t.expiration.toString(16),pubkey:safeBytesToHex(t.pubkey),...r&&{targets:r.map(e=>e.toHex())}},signature:safeBytesToHex(i)}}),publicKey:safeBytesToHex(this.publicKey)}}};let DelegationIdentity=class DelegationIdentity extends a.$4{static fromDelegation(e,t){return new this(e,t)}constructor(e,t){super(),this._inner=e,this._delegation=t}getDelegation(){return this._delegation}getPublicKey(){return{derKey:this._delegation.publicKey,toDer:()=>this._delegation.publicKey}}sign(e){return this._inner.sign(e)}async transformRequest(e){let{body:t,...i}=e,r=await (0,c.vH)(t);return{...i,body:{content:t,sender_sig:await this.sign(new Uint8Array([...l.Wf,...new Uint8Array(r)])),sender_delegation:this._delegation.delegations,sender_pubkey:this._delegation.publicKey}}}};let PartialDelegationIdentity=class PartialDelegationIdentity extends PartialIdentity{#t;get delegation(){return this.#t}constructor(e,t){super(e),this.#t=t}static fromDelegation(e,t){return new PartialDelegationIdentity(e,t)}};function isDelegationValid(e,t){for(let{delegation:t}of e.delegations)if(+new Date(Number(t.expiration/BigInt(1e6)))<=+Date.now())return!1;let i=[],r=t?.scope;for(let t of(r&&(Array.isArray(r)?i.push(...r.map(e=>"string"==typeof e?u.R.fromText(e):e)):i.push("string"==typeof r?u.R.fromText(r):r)),i)){let i=t.toText();for(let{delegation:t}of e.delegations){if(void 0===t.targets)continue;let e=!0;for(let r of t.targets)if(r.toText()===i){e=!1;break}if(e)return!1}}return!0}let g=["mousedown","mousemove","keydown","touchstart","wheel"];let IdleManager=class IdleManager{static create(e={}){return new this(e)}constructor(e={}){this.callbacks=[],this.idleTimeout=6e5,this.timeoutID=void 0;let{onIdle:t,idleTimeout:i=6e5}=e||{};this.callbacks=t?[t]:[],this.idleTimeout=i;let r=this._resetTimer.bind(this);if(window.addEventListener("load",r,!0),g.forEach(function(e){document.addEventListener(e,r,!0)}),e?.captureScroll){let t=((e,t)=>{let i;return(...r)=>{let n=this;clearTimeout(i),i=window.setTimeout(function(){i=void 0,e.apply(n,r)},t)}})(r,e?.scrollDebounce??100);window.addEventListener("scroll",t,!0)}r()}registerCallback(e){this.callbacks.push(e)}exit(){clearTimeout(this.timeoutID),window.removeEventListener("load",this._resetTimer,!0);let e=this._resetTimer.bind(this);g.forEach(function(t){document.removeEventListener(t,e,!0)}),this.callbacks.forEach(e=>e())}_resetTimer(){let e=this.exit.bind(this);window.clearTimeout(this.timeoutID),this.timeoutID=window.setTimeout(e,this.idleTimeout)}};let instanceOfAny=(e,t)=>t.some(t=>e instanceof t);function getIdbProxyableTypes(){return r||(r=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function getCursorAdvanceMethods(){return n||(n=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}let h=new WeakMap,p=new WeakMap,y=new WeakMap,w=new WeakMap,f=new WeakMap;function promisifyRequest(e){let t=new Promise((t,i)=>{let unlisten=()=>{e.removeEventListener("success",success),e.removeEventListener("error",error)},success=()=>{t(wrap_idb_value_wrap(e.result)),unlisten()},error=()=>{i(e.error),unlisten()};e.addEventListener("success",success),e.addEventListener("error",error)});return t.then(t=>{t instanceof IDBCursor&&h.set(t,e)}).catch(()=>{}),f.set(t,e),t}function cacheDonePromiseForTransaction(e){if(p.has(e))return;let t=new Promise((t,i)=>{let unlisten=()=>{e.removeEventListener("complete",complete),e.removeEventListener("error",error),e.removeEventListener("abort",error)},complete=()=>{t(),unlisten()},error=()=>{i(e.error||new DOMException("AbortError","AbortError")),unlisten()};e.addEventListener("complete",complete),e.addEventListener("error",error),e.addEventListener("abort",error)});p.set(e,t)}let _={get(e,t,i){if(e instanceof IDBTransaction){if("done"===t)return p.get(e);if("objectStoreNames"===t)return e.objectStoreNames||y.get(e);if("store"===t)return i.objectStoreNames[1]?void 0:i.objectStore(i.objectStoreNames[0])}return wrap_idb_value_wrap(e[t])},set:(e,t,i)=>(e[t]=i,!0),has:(e,t)=>e instanceof IDBTransaction&&("done"===t||"store"===t)||t in e};function replaceTraps(e){_=e(_)}function wrapFunction(e){return e!==IDBDatabase.prototype.transaction||"objectStoreNames"in IDBTransaction.prototype?getCursorAdvanceMethods().includes(e)?function(...t){return e.apply(unwrap(this),t),wrap_idb_value_wrap(h.get(this))}:function(...t){return wrap_idb_value_wrap(e.apply(unwrap(this),t))}:function(t,...i){let r=e.call(unwrap(this),t,...i);return y.set(r,t.sort?t.sort():[t]),wrap_idb_value_wrap(r)}}function transformCachableValue(e){return"function"==typeof e?wrapFunction(e):(e instanceof IDBTransaction&&cacheDonePromiseForTransaction(e),instanceOfAny(e,getIdbProxyableTypes()))?new Proxy(e,_):e}function wrap_idb_value_wrap(e){if(e instanceof IDBRequest)return promisifyRequest(e);if(w.has(e))return w.get(e);let t=transformCachableValue(e);return t!==e&&(w.set(e,t),f.set(t,e)),t}let unwrap=e=>f.get(e);function openDB(e,t,{blocked:i,upgrade:r,blocking:n,terminated:a}={}){let o=indexedDB.open(e,t),s=wrap_idb_value_wrap(o);return r&&o.addEventListener("upgradeneeded",e=>{r(wrap_idb_value_wrap(o.result),e.oldVersion,e.newVersion,wrap_idb_value_wrap(o.transaction),e)}),i&&o.addEventListener("blocked",e=>i(e.oldVersion,e.newVersion,e)),s.then(e=>{a&&e.addEventListener("close",()=>a()),n&&e.addEventListener("versionchange",e=>n(e.oldVersion,e.newVersion,e))}).catch(()=>{}),s}let m=["get","getKey","getAll","getAllKeys","count"],b=["put","add","delete","clear"],v=new Map;function getMethod(e,t){if(!(e instanceof IDBDatabase&&!(t in e)&&"string"==typeof t))return;if(v.get(t))return v.get(t);let i=t.replace(/FromIndex$/,""),r=t!==i,n=b.includes(i);if(!(i in(r?IDBIndex:IDBObjectStore).prototype)||!(n||m.includes(i)))return;let method=async function(e,...t){let a=this.transaction(e,n?"readwrite":"readonly"),o=a.store;return r&&(o=o.index(t.shift())),(await Promise.all([o[i](...t),n&&a.done]))[0]};return v.set(t,method),method}replaceTraps(e=>({...e,get:(t,i,r)=>getMethod(t,i)||e.get(t,i,r),has:(t,i)=>!!getMethod(t,i)||e.has(t,i)}));let D="auth-client-db",I="ic-keyval",_openDbStore=async(e=D,t=I,i)=>(k&&localStorage?.getItem(E)&&(localStorage.removeItem(E),localStorage.removeItem(S)),await openDB(e,i,{upgrade:e=>{e.objectStoreNames.contains(t)&&e.clear(t),e.createObjectStore(t)}}));async function _getValue(e,t,i){return await e.get(t,i)}async function _setValue(e,t,i,r){return await e.put(t,r,i)}async function _removeValue(e,t,i){return await e.delete(t,i)}let IdbKeyVal=class IdbKeyVal{static async create(e){let{dbName:t=D,storeName:i=I,version:r=x}=e??{},n=await _openDbStore(t,i,r);return new IdbKeyVal(n,i)}constructor(e,t){this._db=e,this._storeName=t}async set(e,t){return await _setValue(this._db,this._storeName,e,t)}async get(e){return await _getValue(this._db,this._storeName,e)??null}async remove(e){return await _removeValue(this._db,this._storeName,e)}};let S="identity",E="delegation",x=1,k=!1;let LocalStorage=class LocalStorage{constructor(e="ic-",t){this.prefix=e,this._localStorage=t}get(e){return Promise.resolve(this._getLocalStorage().getItem(this.prefix+e))}set(e,t){return this._getLocalStorage().setItem(this.prefix+e,t),Promise.resolve()}remove(e){return this._getLocalStorage().removeItem(this.prefix+e),Promise.resolve()}_getLocalStorage(){if(this._localStorage)return this._localStorage;let e="undefined"==typeof global?"undefined"==typeof self?void 0:self.localStorage:global.localStorage;if(!e)throw Error("Could not find local storage.");return e}};let IdbStorage=class IdbStorage{#i;constructor(e){this.#i=e??{}}get _db(){return new Promise((e,t)=>{if(this.initializedDb){e(this.initializedDb);return}IdbKeyVal.create(this.#i).then(t=>{this.initializedDb=t,e(t)}).catch(t)})}async get(e){let t=await this._db;return await t.get(e)}async set(e,t){let i=await this._db;await i.set(e,t)}async remove(e){let t=await this._db;await t.remove(e)}};let P=BigInt(1e9),K=BigInt(3600),C=BigInt(8)*(P*K),T="ECDSA",A="Ed25519";let AuthClient=class AuthClient{static async create(e={}){let t;let i=e.storage??new IdbStorage,r=e.keyType??T,n=null;if(e.identity)n=e.identity;else{let e=await i.get(S);if(!e&&k)try{let t=new LocalStorage,n=await t.get(E),a=await t.get(S);n&&a&&r===T&&(console.log("Discovered an identity stored in localstorage. Migrating to IndexedDB"),await i.set(E,n),await i.set(S,a),e=n,await t.remove(E),await t.remove(S))}catch(e){console.error("error while attempting to recover localstorage: "+e)}if(e)try{"object"==typeof e?n=r===A&&"string"==typeof e?o.R.fromJSON(e):await ECDSAKeyIdentity.fromKeyPair(e):"string"==typeof e&&(n=o.R.fromJSON(e))}catch{}}let s=new a.ed,l=null;if(n)try{let t=await i.get(E);if("object"==typeof t&&null!==t)throw Error("Delegation chain is incorrectly stored. A delegation chain should be stored as a string.");e.identity?s=e.identity:t&&(l=DelegationChain.fromJSON(t),isDelegationValid(l)?s="toDer"in n?PartialDelegationIdentity.fromDelegation(n,l):DelegationIdentity.fromDelegation(n,l):(await _deleteStorage(i),n=null))}catch(e){console.error(e),await _deleteStorage(i),n=null}return e.idleOptions?.disableIdle?t=void 0:(l||e.identity)&&(t=IdleManager.create(e.idleOptions)),n||(r===A?(n=o.R.generate(),await i.set(S,JSON.stringify(n.toJSON()))):(e.storage&&r===T&&console.warn(`You are using a custom storage provider that may not support CryptoKey storage. If you are using a custom storage provider that does not support CryptoKey storage, you should use '${A}' as the key type, as it can serialize to a string`),n=await ECDSAKeyIdentity.generate(),await i.set(S,n.getKeyPair()))),new this(s,n,l,i,t,e)}constructor(e,t,i,r,n,a,o,s){this._identity=e,this._key=t,this._chain=i,this._storage=r,this.idleManager=n,this._createOptions=a,this._idpWindow=o,this._eventHandler=s,this._registerDefaultIdleCallback()}_registerDefaultIdleCallback(){let e=this._createOptions?.idleOptions;e?.onIdle||e?.disableDefaultIdleCallback||this.idleManager?.registerCallback(()=>{this.logout(),location.reload()})}async _handleSuccess(e,t){let i=e.delegations.map(e=>({delegation:new Delegation(e.delegation.pubkey,e.delegation.expiration,e.delegation.targets),signature:e.signature})),r=DelegationChain.fromDelegations(i,e.userPublicKey),n=this._key;if(!n)return;this._chain=r,"toDer"in n?this._identity=PartialDelegationIdentity.fromDelegation(n,this._chain):this._identity=DelegationIdentity.fromDelegation(n,this._chain),this._idpWindow?.close();let a=this._createOptions?.idleOptions;this.idleManager||a?.disableIdle||(this.idleManager=IdleManager.create(a),this._registerDefaultIdleCallback()),this._removeEventListener(),delete this._idpWindow,this._chain&&await this._storage.set(E,JSON.stringify(this._chain.toJSON())),t?.(e)}getIdentity(){return this._identity}async isAuthenticated(){return!this.getIdentity().getPrincipal().isAnonymous()&&null!==this._chain&&isDelegationValid(this._chain)}async login(e){let t=mergeLoginOptions(this._createOptions?.loginOptions,e),i=t?.maxTimeToLive??C,r=new URL(t?.identityProvider?.toString()||"https://identity.internetcomputer.org");r.hash="#authorize",this._idpWindow?.close(),this._removeEventListener(),this._eventHandler=this._getEventHandler(r,{maxTimeToLive:i,...t}),window.addEventListener("message",this._eventHandler),this._idpWindow=window.open(r.toString(),"idpWindow",t?.windowOpenerFeatures)??void 0;let checkInterruption=()=>{this._idpWindow&&(this._idpWindow.closed?this._handleFailure("UserInterrupt",t?.onError):setTimeout(checkInterruption,500))};checkInterruption()}_getEventHandler(e,t){return async i=>{if(i.origin!==e.origin)return;let r=i.data;switch(r.kind){case"authorize-ready":{let i={kind:"authorize-client",sessionPublicKey:new Uint8Array(this._key?.getPublicKey().toDer()),maxTimeToLive:t?.maxTimeToLive,allowPinAuthentication:t?.allowPinAuthentication,derivationOrigin:t?.derivationOrigin?.toString(),...t?.customValues};this._idpWindow?.postMessage(i,e.origin);break}case"authorize-client-success":try{await this._handleSuccess(r,t?.onSuccess)}catch(e){this._handleFailure(e.message,t?.onError)}break;case"authorize-client-failure":this._handleFailure(r.text,t?.onError)}}}_handleFailure(e,t){this._idpWindow?.close(),t?.(e),this._removeEventListener(),delete this._idpWindow}_removeEventListener(){this._eventHandler&&window.removeEventListener("message",this._eventHandler),this._eventHandler=void 0}async logout(e={}){if(await _deleteStorage(this._storage),this._identity=new a.ed,this._chain=null,e.returnTo)try{window.history.pushState({},"",e.returnTo)}catch{window.location.href=e.returnTo}}};async function _deleteStorage(e){await e.remove(S),await e.remove(E),await e.remove("iv")}function mergeLoginOptions(e,t){if(!e&&!t)return;let i=e?.customValues||t?.customValues?{...e?.customValues,...t?.customValues}:void 0;return{...e,...t,customValues:i}}}};