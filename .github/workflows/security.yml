name: Security Audit
on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    - cron: '0 0 * * 1' # Weekly on Monday

jobs:
  code-security:
    name: Code Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'pnpm'

      - name: Install dependencies
        run: |
          npm install -g pnpm
          pnpm install

      - name: Run security audit
        run: |
          # Node.js security audit
          pnpm audit --audit-level high || true
          
          # Run linting and type checking
          pnpm lint
          pnpm type-check || true

      - name: Run tests
        run: pnpm test || true

      - name: Upload security audit artifacts
        uses: actions/upload-artifact@v4
        with:
          name: security-audit-reports
          path: |
            security/pnpm-audit.json
            security/eslint-report.json
          retention-days: 30

  smart-contract-security:
    name: Smart Contract Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install Slither
        run: |
          pip install slither-analyzer

      - name: Run Slither analysis
        run: |
          mkdir -p security
          # Analyze Solidity contracts if they exist
          if [ -d "contracts" ] && [ "$(ls -A contracts/*.sol 2>/dev/null)" ]; then
            slither contracts/ --fail-medium --json security/slither-report.json || true
          else
            echo "No Solidity contracts found to analyze" | tee security/slither-report.json
          fi

      - name: Upload Slither artifacts
        uses: actions/upload-artifact@v4
        with:
          name: slither-reports
          path: security/slither-report.json
          retention-days: 30

  motoko-security:
    name: Motoko Canister Security
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install DFX
        run: |
          DFX_VERSION=0.15.1
          curl -L https://github.com/dfinity/sdk/releases/download/$DFX_VERSION/dfx-$DFX_VERSION-x86_64-linux.tar.gz | tar -xz
          sudo mv dfx /usr/local/bin/

      - name: Build and test canisters
        run: |
          dfx start --background --clean
          dfx deploy
          # Run canister tests if available
          if [ -f "canisters/test-runner/run-tests.sh" ]; then
            cd canisters/test-runner && ./run-tests.sh || true
          elif [ -f "scripts/test-hhu-token.cjs" ]; then
            node scripts/test-hhu-token.cjs || true
          else
            echo "No specific canister tests found, running basic deployment check"
          fi

      - name: Upload canister test artifacts
        uses: actions/upload-artifact@v4
        with:
          name: canister-test-results
          path: |
            .dfx/**/canister_ids.json
            canisters/**/test-results/
          retention-days: 30

  eslint-security:
    name: ESLint Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'pnpm'

      - name: Install dependencies
        run: |
          npm install -g pnpm
          pnpm install

      - name: Run ESLint security scan
        run: |
          mkdir -p security
          # Run ESLint across all TypeScript/JavaScript files
          pnpm -w dlx eslint "apps/**/src/**/*.{ts,tsx,js,jsx}" --format json --output-file security/eslint-report.json --max-warnings=0 || true

      - name: Upload ESLint artifacts
        uses: actions/upload-artifact@v4
        with:
          name: eslint-reports
          path: security/eslint-report.json
          retention-days: 30

  pnpm-audit:
    name: PNPM Security Audit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'pnpm'

      - name: Install dependencies
        run: |
          npm install -g pnpm
          pnpm install

      - name: Run comprehensive PNPM audit
        run: |
          mkdir -p security
          # Run audit and capture results
          pnpm -w audit --json > security/pnpm-audit.json || true
          
          # Check for critical vulnerabilities
          if command -v jq >/dev/null 2>&1; then
            CRITICAL_COUNT=$(jq '[.advisories | to_entries[] | select(.value.severity == "critical")] | length' security/pnpm-audit.json)
            HIGH_COUNT=$(jq '[.advisories | to_entries[] | select(.value.severity == "high")] | length' security/pnpm-audit.json)
            echo "Critical vulnerabilities: $CRITICAL_COUNT"
            echo "High vulnerabilities: $HIGH_COUNT"
            
            if [ "$CRITICAL_COUNT" -gt 0 ] || [ "$HIGH_COUNT" -gt 10 ]; then
              echo "âŒ Critical or excessive high vulnerabilities detected"
              exit 1
            fi
          fi

      - name: Upload PNPM audit artifacts
        uses: actions/upload-artifact@v4
        with:
          name: pnpm-audit-reports
          path: security/pnpm-audit.json
          retention-days: 30

  secret-scan:
    name: Secret Scanning
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run TruffleHog secret scan
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.pull_request.base.sha || github.sha }}
          head: ${{ github.sha }}
          extra_args: --json

      - name: Upload secret scan results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: secret-scan-results
          path: trufflehog-results.json
          retention-days: 30
name: Security Audit
on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    - cron: '0 0 * * 1' # Weekly on Monday

jobs:
  code-security:
    name: Code Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'pnpm'

      - name: Install dependencies
        run: |
          npm install -g pnpm
          pnpm install

      - name: Run security audit
        run: |
          # Node.js security audit
          pnpm audit --audit-level high || true
          
          # Run linting and type checking
          pnpm lint || true
          pnpm type-check || true

      - name: Run tests
        run: pnpm test || true

  smart-contract-security:
    name: Smart Contract Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install Slither
        run: |
          pip install slither-analyzer

      - name: Run Slither analysis
        run: |
          # Analyze Solidity contracts if they exist
          if [ -d "contracts" ] && [ "$(ls -A contracts/*.sol 2>/dev/null)" ]; then
            slither contracts/ --fail-medium || true
          else
            echo "No Solidity contracts found to analyze"
          fi

  motoko-security:
    name: Motoko Canister Security
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install DFX
        run: |
          DFX_VERSION=0.15.1
          curl -L https://github.com/dfinity/sdk/releases/download/$DFX_VERSION/dfx-$DFX_VERSION-x86_64-linux.tar.gz | tar -xz
          sudo mv dfx /usr/local/bin/

      - name: Build and test canisters
        run: |
          dfx start --background --clean
          dfx deploy || true
          # Add canister-specific tests here

  container-security:
    name: Container Security Scan
    runs-on: ubuntu-latest
    if: false  # Disabled until we have Dockerfiles
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Upload Trivy scan results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: 'trivy-results.sarif'

  secret-scan:
    name: Secret Scanning
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Detect secrets
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.pull_request.base.sha || github.sha }}
          head: ${{ github.sha }}
